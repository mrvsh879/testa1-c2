<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CEFR тест A1–C2 — мульти-язычный с AI-аудитом</title>
<meta name="description" content="Профессиональный CEFR тест A1–C2: 48 вопросов, антиугадывание, надёжность, AI-аудит результата и взвешенный индекс. Мульти-язычный UI и банк вопросов." />
<style>
  :root{--bg:#0f1221;--card:#171a2e;--muted:#8b91b2;--text:#e9ecf7;--accent:#6ea8fe;--ok:#2ecc71;--bad:#ff6b6b;--warn:#ffd166}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#0d1020 0%,#0f1221 60%,#0b0f1a 100%);color:var(--text)}
  .wrap{max-width:960px;margin:0 auto;padding:24px}
  .card{background:var(--card);border:1px solid #202547;box-shadow:0 10px 30px rgba(0,0,0,.35);border-radius:16px;padding:20px}
  h1{margin:0 0 12px;font-size:24px;letter-spacing:.2px}
  .muted{color:var(--muted)}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .col{flex:1 1 300px}
  .btn{appearance:none;border:1px solid #27305b;background:#1c2242;color:var(--text);padding:12px 16px;border-radius:12px;font-weight:600;cursor:pointer;transition:.15s}
  .btn:hover{transform:translateY(-1px);background:#212a54}
  .btn.primary{background:linear-gradient(180deg,#6ea8fe,#4c7ef5);border-color:#345bd6;color:#051028}
  .btn.ghost{background:transparent;border-color:#2a335f}
  .btn.ok{background:#0f3a26;border-color:#1f7a50}
  .bar{height:10px;background:#10142b;border:1px solid #2a2e56;border-radius:999px;overflow:hidden}
  .bar>div{height:100%;background:linear-gradient(90deg,#4c7ef5,#6ea8fe)}
  .grid{display:grid;gap:14px}
  .kpi{display:flex;align-items:center;gap:8px;padding:10px 12px;background:#11142a;border:1px solid #23264a;border-radius:12px}
  .kpi .v{font-weight:700}
  .q{padding:16px;border:1px solid #242953;border-radius:12px;background:#121634}
  .q h3{margin:0 0 10px;font-size:16px}
  .opt{display:block;border:1px solid #2a2f61;border-radius:10px;padding:10px;cursor:pointer;background:#111539}
  .opt input{margin-right:8px}
  .opt+.opt{margin-top:8px}
  .opt.correct{border-color:#1f8c5a;background:#0e2e22}
  .opt.wrong{border-color:#9e2e2e;background:#2a1111}
  .level-tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #2a2e56;color:#aeb7e8}
  .footer{display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;margin-top:16px}
  .note{padding:10px 12px;background:#0e122b;border:1px dashed #2b3166;border-radius:12px}
  .hidden{display:none}
  .badge{padding:2px 8px;border-radius:999px;border:1px solid #2b3166;background:#0e122b;color:#aeb7e8}
  .result{padding:16px;border:1px solid #2a2e56;border-radius:12px;background:#0f1431}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border-bottom:1px solid #23264c;padding:8px;text-align:left}
  .hr{height:1px;background:#252a53;margin:16px 0}
  .small{font-size:12px}
  .chip{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #2b3166;margin-right:6px;margin-bottom:6px}
  .ai{background:#0b152b;border-color:#20325d}
  .spinner{width:16px;height:16px;border:2px solid #2a3f7a;border-top-color:#6ea8fe;border-radius:50%;display:inline-block;animation:spin .9s linear infinite}
  select{appearance:none;background:#0e122b;border:1px solid #2a2e56;color:#e9ecf7;border-radius:10px;padding:10px 12px}
  @keyframes spin{to{transform:rotate(360deg)}}
  @media (max-width:520px){.footer{flex-direction:column}}
  @media print{.wrap{padding:0}.card{box-shadow:none;border:0;border-radius:0}}
</style>
</head>
<body>
<div class="wrap">
  <!-- INTRO -->
  <div class="card" id="screen-intro">
    <h1 id="introTitle">Тест уровня языка A1–C2</h1>
    <p class="muted" id="introDescr">48 вопросов (по 8 на уровень). Антиугадывание. Итог проверит AI. Плюс «взвешенный индекс» — мягкая оценка.</p>

    <div class="row" style="align-items:flex-start">
      <div class="col grid">
        <div class="kpi"><span id="fmtLabel">Формат:</span><span class="v" id="fmtValue">Multiple choice + «Не знаю»</span></div>
        <div class="kpi"><span id="penLabel">Штраф за ошибку:</span><span class="v" id="penValue">−0.33</span></div>
        <div class="kpi"><span>AI-аудит:</span><span class="v" id="aiDescr">коррекция уровня и доверия</span></div>
      </div>
      <div class="col note">
        <strong id="honestyStrong">Честность важна:</strong>
        <span id="honestyNote">без переводчиков, не подсматривайте. AI анализирует скорость/паттерны.</span>
      </div>
    </div>

    <div class="hr"></div>

    <!-- выборы языков -->
    <div class="row">
      <div class="col">
        <label class="small muted" id="uiLangLabel">Язык интерфейса</label><br/>
        <select id="uiSelect">
          <option value="ru">Русский (ru)</option>
          <option value="uk">Українська (uk)</option>
          <option value="en">English (en)</option>
        </select>
      </div>
      <div class="col">
        <label class="small muted" id="testLangLabel">Язык теста</label><br/>
        <select id="testSelect">
          <option value="de">Deutsch (de)</option>
          <option value="pl">Polski (pl)</option>
          <option value="cs">Čeština (cs)</option>
          <option value="it">Italiano (it)</option>
          <option value="fr">Français (fr)</option>
          <option value="ro">Română (ro)</option>
          <option value="sk">Slovenčina (sk)</option>
        </select>
      </div>
    </div>

    <div class="hr"></div>

    <label class="opt" style="background:#0f1431">
      <input type="checkbox" id="honesty" /> <span id="honestyCheck">Подтверждаю честное прохождение без посторонней помощи.</span>
    </label>

    <div class="footer">
      <div class="bar" style="flex:1"><div style="width:0%"></div></div>
      <button class="btn primary" id="startBtn">Начать тест</button>
    </div>
    <p id="aiWarn" class="small muted" style="margin-top:10px;"></p>
  </div>

  <!-- TEST -->
  <div class="card hidden" id="screen-test">
    <div class="footer">
      <div><span class="badge" id="progressBadge">Вопрос 1 / 48</span></div>
      <div class="bar" style="flex:1;max-width:400px"><div id="progressBar" style="width:0%"></div></div>
      <div>
        <span class="badge" id="timerBadge">00:00</span>
        <span class="badge" id="speedBadge">скорость: —</span>
      </div>
    </div>
    <div id="questionHost" class="grid" style="margin-top:12px"></div>
    <div class="footer">
      <div class="muted small"><span id="qLevelLabel">Уровень вопроса:</span> <span id="lvlTag" class="level-tag">—</span></div>
      <div>
        <button class="btn ghost" id="prevBtn">← Назад</button>
        <button class="btn" id="nextBtn">Далее →</button>
        <button class="btn ok hidden" id="finishBtn">Завершить тест</button>
      </div>
    </div>
  </div>

  <!-- RESULT -->
  <div class="card hidden" id="screen-result">
    <h2 style="margin:0 0 6px" id="resultTitle">Ваш результат</h2>
    <div id="headline"></div>
    <div class="hr"></div>
    <div class="grid">
      <div class="result" id="summaryBox"></div>
      <div class="result">
        <h3 style="margin:0 0 8px" id="profileTitle">Профиль по уровням</h3>
        <table class="table" id="bandTable">
          <thead><tr><th id="thLevel">Уровень</th><th id="thCorrect">Верно</th><th id="thTotal">Всего</th><th id="thAcc">Точность</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="result">
        <h3 style="margin:0 0 8px" id="recoTitle">Рекомендации</h3>
        <div id="reco"></div>
      </div>
      <div class="result ai" id="aiPanel">
        <h3 style="margin:0 0 8px" id="aiPanelTitle">AI-аудит результата</h3>
        <div id="aiStatus" class="small muted"><span class="spinner"></span> <span id="aiAnalyzing">Анализ результата AI…</span></div>
        <div id="aiBox" class="hidden"></div>
      </div>
    </div>
    <div class="hr"></div>
    <div class="footer">
      <button class="btn" id="reviewBtn">Просмотреть ответы</button>
      <button class="btn" id="printBtn">Печать / PDF</button>
      <button class="btn primary" id="downloadBtn">Скачать отчёт (.json)</button>
      <button class="btn ghost" id="restartBtn">Пройти заново</button>
    </div>
  </div>
</div>

<script>
  /* ========= 1) Константы ========= */
  // Твой AI-прокси (Apps Script)
  const AI_ENDPOINT = "https://script.google.com/macros/s/AKfycbxIoMsVU88aW_rGXGR_ScjovjPrMGCMloEqEUFV8guay_emA-aW5nLFujz5-4xSpjPjKA/exec";

  // Маппинг локали для AI по языку теста
  const TEST_LOCALE = {
    de: "de-DE", pl: "pl-PL", cs: "cs-CZ", it: "it-IT",
    fr: "fr-FR", ro: "ro-RO", sk: "sk-SK"
  };

  // Текущие параметры (из URL или localStorage)
  function getParam(name, def) {
    const p = new URLSearchParams(location.search).get(name);
    return p || def;
  }
  const UI_LANG   = getParam('ui',  localStorage.getItem('ui_lang')   || 'ru');
  const TEST_LANG = getParam('test',localStorage.getItem('test_lang') || 'de');

  // Глобальные данные
  let I18N = {};       // словарь интерфейса
  let QUESTIONS = [];  // банк вопросов (48; каждый с опцией "Не знаю" на 5-й позиции)

  /* ========= 2) Утилиты ========= */
  function qs(s){return document.querySelector(s)}
  function clamp(n,a,b){return Math.max(a,Math.min(b,n))}
  function fmtSec(s){const m=Math.floor(s/60),r=s%60;return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`}

  async function loadJSON(url){
    const r = await fetch(url, {cache:'no-store'});
    if(!r.ok) throw new Error('HTTP '+r.status+' '+url);
    return r.json();
  }

  function t(key, vars={}) {
    let s = I18N[key] || key;
    for (const [k,v] of Object.entries(vars)) s = s.replaceAll(`{{${k}}}`, String(v));
    return s;
  }

  function sanitize(t){
    return String(t).replace(/[&<>"]/g, s => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[s]));
  }

  function setSelectValue(id, val){
    const el = qs(id);
    if (el) el.value = val;
  }

  function updateUrl(ui, test){
    const url = new URL(location.href);
    url.searchParams.set('ui', ui);
    url.searchParams.set('test', test);
    history.replaceState(null, "", url.toString());
  }

  /* ========= 3) Загрузка i18n + вопросов ========= */
  async function initI18n() {
    try {
      I18N = await loadJSON(`./i18n/${UI_LANG}.json`);
    } catch (e) {
      // Fallback RU
      I18N = await loadJSON(`./i18n/ru.json`);
    }
    localStorage.setItem('ui_lang', UI_LANG);

    // Применить тексты на Intro и Result (ключевые)
    qs('#introTitle').textContent = t('appTitle', { LANG: TEST_LANG.toUpperCase() });
    qs('#introDescr').textContent = t('appDescr');
    qs('#fmtLabel').textContent = t('format') + ':';
    qs('#fmtValue').textContent = t('formatDesc');
    qs('#penLabel').textContent = t('penalty') + ':';
    qs('#penValue').textContent = t('penaltyValue');
    qs('#aiDescr').textContent = t('aiAuditDesc');
    qs('#honestyStrong').textContent = t('honestyNoteStrong');
    qs('#honestyNote').textContent = t('honestyNote');
    qs('#honestyCheck').textContent = t('honestyCheck');

    qs('#startBtn').textContent = t('start');
    qs('#prevBtn').textContent = t('prev');
    qs('#nextBtn').textContent = t('next');
    qs('#finishBtn').textContent = t('finish');

    qs('#qLevelLabel').textContent = t('questionLevel');
    qs('#resultTitle').textContent = t('resultTitle');
    qs('#profileTitle').textContent = t('profileByBands');
    qs('#recoTitle').textContent = t('recommendations');
    qs('#aiPanelTitle').textContent = t('aiPanelTitle');
    qs('#aiAnalyzing').textContent = t('aiAnalyzing');

    qs('#thLevel').textContent = t('bandLevel');
    qs('#thCorrect').textContent = t('bandCorrect');
    qs('#thTotal').textContent = t('bandTotal');
    qs('#thAcc').textContent = t('bandAccuracy');

    qs('#reviewBtn').textContent = t('review');
    qs('#printBtn').textContent  = t('print');
    qs('#downloadBtn').textContent = t('download');
    qs('#restartBtn').textContent = t('restart');

    // подпись про AI
    const warn = qs('#aiWarn');
    warn.textContent = (AI_ENDPOINT && AI_ENDPOINT.includes('/exec'))
      ? t('aiConnected')
      : t('aiNotConnected');
  }

  async function initQuestions() {
    const data = await loadJSON(`./questions/${TEST_LANG}.json`);
    // допускаем формат {questions:[...]} или {levels:{A1:[],...}}
    if (Array.isArray(data.questions)) {
      QUESTIONS = data.questions;
    } else if (data.levels) {
      const levels = ["A1","A2","B1","B2","C1","C2"];
      const all = [];
      for (const L of levels) {
        (data.levels[L] || []).forEach(q => { q.level=L; all.push(q); });
      }
      QUESTIONS = all;
    } else {
      throw new Error('Формат файла вопросов не распознан');
    }
    localStorage.setItem('test_lang', TEST_LANG);
    document.title = t('appTitle', { LANG: TEST_LANG.toUpperCase() });
  }

  /* ========= 4) Селекторы языков ========= */
  setSelectValue('#uiSelect', UI_LANG);
  setSelectValue('#testSelect', TEST_LANG);

  qs('#uiSelect').addEventListener('change', (e)=>{
    const newUi = e.target.value;
    updateUrl(newUi, TEST_LANG);
    location.reload();
  });
  qs('#testSelect').addEventListener('change', (e)=>{
    const newTest = e.target.value;
    updateUrl(UI_LANG, newTest);
    location.reload();
  });

  /* ========= 5) Состояние теста ========= */
  const state = { startedAt:null, current:0, answers:{}, times:{}, qStartAt:null, honesty:false };
  let total = 0, order = [];

  const intro = qs('#screen-intro'), test = qs('#screen-test'), result = qs('#screen-result');
  const startBtn = qs('#startBtn'), honestyCb = qs('#honesty');
  const questionHost = qs('#questionHost'), progressBar = qs('#progressBar'), progressBadge = qs('#progressBadge'), lvlTag = qs('#lvlTag');
  const prevBtn = qs('#prevBtn'), nextBtn = qs('#nextBtn'), finishBtn = qs('#finishBtn');
  const timerBadge = qs('#timerBadge'), speedBadge = qs('#speedBadge');
  const headline = qs('#headline'), summaryBox = qs('#summaryBox'), bandTableBody = qs('#bandTable tbody'), reco = qs('#reco');
  const reviewBtn = qs('#reviewBtn'), printBtn = qs('#printBtn'), downloadBtn = qs('#downloadBtn'), restartBtn = qs('#restartBtn');
  const aiStatus = qs('#aiStatus'), aiBox = qs('#aiBox');

  let tickTimer=null;

  /* ========= 6) Навигация + таймер ========= */
  startBtn.addEventListener('click',()=>{
    if(!honestyCb.checked){ alert(t('alertHonesty')); return; }
    state.honesty = true; state.startedAt=Date.now(); state.qStartAt=Date.now();
    intro.classList.add('hidden'); test.classList.remove('hidden'); renderCurrent(); tick();
  });

  function tick(){
    clearInterval(tickTimer);
    tickTimer = setInterval(()=>{
      const elapsed = Math.floor((Date.now()-state.startedAt)/1000);
      timerBadge.textContent = fmtSec(elapsed);
      const answered = Object.keys(state.answers).length || 1;
      const avg = elapsed / answered;
      speedBadge.textContent = `${t('speed') || 'скорость'}: ${avg.toFixed(1)} ${t('secPerQ') || 'c/вопр'}`;
    },1000);
  }

  prevBtn.addEventListener('click',()=>move(-1));
  nextBtn.addEventListener('click',()=>move(1));
  finishBtn.addEventListener('click',()=>finish());

  function saveTimeForCurrent(){
    const q = QUESTIONS[order[state.current]];
    const spent = Math.floor((Date.now()-state.qStartAt)/1000);
    state.times[q.id] = (state.times[q.id] || 0) + spent;
    state.qStartAt = Date.now();
  }
  function move(delta){
    saveTimeForCurrent();
    state.current = clamp(state.current+delta,0,total-1);
    renderCurrent();
  }

  function renderCurrent(){
    const idx = state.current;
    const q = QUESTIONS[order[idx]];
    progressBadge.textContent = `${t('progressQ') || 'Вопрос'} ${idx+1} / ${total}`;
    progressBar.style.width = `${((idx+1)/total*100).toFixed(1)}%`;
    lvlTag.textContent = q.level;

    questionHost.innerHTML = '';
    const box = document.createElement('div'); box.className='q';
    box.innerHTML = `<h3>${sanitize(q.q)}</h3>`;
    q.options.forEach((opt,optIdx)=>{
      const lab = document.createElement('label'); lab.className='opt';
      const input = document.createElement('input'); input.type='radio'; input.name='opt'; input.value=optIdx;
      if(state.answers[q.id]===optIdx) input.checked = true;
      lab.appendChild(input); lab.insertAdjacentText('beforeend', opt);
      lab.addEventListener('click',()=>{
        state.answers[q.id] = optIdx;
        setTimeout(()=>{ if(state.current<total-1){move(1)}else{nextBtn.classList.add('hidden');finishBtn.classList.remove('hidden')} },80);
      });
      box.appendChild(lab);
    });
    questionHost.appendChild(box);

    prevBtn.disabled = idx===0;
    nextBtn.classList.toggle('hidden', idx===total-1);
    finishBtn.classList.toggle('hidden', idx!==total-1);
  }

  /* ========= 7) Подсчёт (антиугадывание) ========= */
  // ВНИМАНИЕ: пятая опция (индекс 4) — «Не знаю». Мы не штрафуем за неё.
  function scoreReport(){
    const perBand = {A1:[],A2:[],B1:[],B2:[],C1:[],C2:[]};
    let penalized=0, correct=0, wrong=0, skip=0;
    const details=[];

    QUESTIONS.forEach(q=>{
      const ans = state.answers[q.id];
      let delta=0;
      if(ans===undefined || ans===4){ delta=0; skip++; }
      else if(ans===q.answerIdx){ delta=1; correct++; }
      else { delta=-0.33; wrong++; }
      penalized += delta;
      perBand[q.level].push({id:q.id,correct:ans===q.answerIdx,delta});
      details.push({id:q.id,level:q.level,chosen:ans??null,correctIdx:q.answerIdx,delta,timeSec:state.times[q.id]||0});
    });

    const bandRates={};
    Object.keys(perBand).forEach(b=>{
      const arr=perBand[b], tot=arr.length, ok=arr.filter(x=>x.correct).length;
      bandRates[b]={ok,total:tot,rate: tot? ok/tot : 0};
    });

    // Взвешенный индекс по уровням
    const bandToIdx = { A1:1, A2:2, B1:3, B2:4, C1:5, C2:6 };
    let num=0, den=0;
    for(const b of Object.keys(bandRates)){
      const r = bandRates[b].rate;
      num += (bandToIdx[b]||0) * r;
      den += r;
    }
    const weightedIdx = den ? num/den : 0;
    function idxToBand(x){
      if (x < 1.5) return "A1";
      if (x < 2.5) return "A2";
      if (x < 3.5) return "B1";
      if (x < 4.5) return "B2";
      if (x < 5.5) return "C1";
      return "C2";
    }
    const weightedLevel = den ? idxToBand(weightedIdx) : "A0";

    // «Жёсткий» по порогам
    const passReq = {A1:.70,A2:.65,B1:.60,B2:.60,C1:.55,C2:.50};
    const orderBands=["A1","A2","B1","B2","C1","C2"];
    let achieved="A0";
    for (const b of orderBands) {
      if ((bandRates[b]?.rate || 0) >= passReq[b]) achieved = b;
    }

    const totalSec = Math.floor((Date.now()-state.startedAt)/1000);
    const avgSec = totalSec / Math.max(1,Object.keys(state.answers).length||1);
    const fast = avgSec < 4.0;
    let reliability = 1.0;
    if(fast) reliability -= 0.25;
    if(!state.honesty) reliability -= 0.15;
    if(skip===0 && wrong>correct) reliability -= 0.1;
    reliability = clamp(reliability,0,1);

    const maxRaw = QUESTIONS.length;
    const norm = clamp((penalized + (QUESTIONS.length*0.33)) / (maxRaw+QUESTIONS.length*0.33), 0,1);

    return {
      achieved, weightedLevel, weightedIdx:+weightedIdx.toFixed(2),
      bandRates, penalized:+penalized.toFixed(2),
      correct, wrong, skip, total: QUESTIONS.length,
      totalSec, avgSec:+avgSec.toFixed(1), reliability:+reliability.toFixed(2),
      norm:+norm.toFixed(2), details
    };
  }

  /* ========= 8) Завершение, отчёт и рекомендации ========= */
  async function finish(){
    saveTimeForCurrent();
    test.classList.add('hidden'); clearInterval(tickTimer);
    const report = scoreReport();
    showResult(report);
    aiAudit(report).catch(()=>{ aiStatus.textContent = t('aiFetchError'); });
  }

  function showResult(r){
    result.classList.remove('hidden');
    const levelBadges={
      "A1": t('levelBadgeA1') || "Начальный",
      "A2": t('levelBadgeA2') || "Элементарный",
      "B1": t('levelBadgeB1') || "Средний",
      "B2": t('levelBadgeB2') || "Уверенный средний",
      "C1": t('levelBadgeC1') || "Продвинутый",
      "C2": t('levelBadgeC2') || "Владение",
      "A0": t('belowA1') || "Ниже A1"
    };

    headline.innerHTML = `
      <div class="kpi">
        <span>${t('weightedLevel') || 'Взвешенный уровень'}:</span>
        <span class="v" style="margin-left:6px">${r.weightedLevel}</span>
        <span class="chip">${levelBadges[r.weightedLevel]||""}</span>
      </div>
      <div class="small muted" style="margin-top:6px">
        ${(t('strictBand') || 'Жёсткий по порогам')}: <strong>${r.achieved}</strong> · ${t('weightedIndex')||'Индекс'} = ${r.weightedIdx ?? "-"}
      </div>
    `;

    summaryBox.innerHTML = `
      <div class="grid">
        <div class="kpi"><span>${t('scoreWithPenalty') || 'Баллы с антиугадыванием'}:</span> <span class="v">${r.penalized} / ${r.total}</span></div>
        <div class="kpi"><span>${t('answersBreakdown') || 'Правильно / Ошибки / «Не знаю»'}:</span> <span class="v">${r.correct} / ${r.wrong} / ${r.skip}</span></div>
        <div class="kpi"><span>${t('time') || 'Время'}:</span> <span class="v">${fmtSec(r.totalSec)} (${t('timeAvg')||'ср.'} ${r.avgSec}s/${t('progressQ')||'вопр'})</span></div>
        <div class="kpi"><span>${t('reliability') || 'Надёжность прохождения'}:</span> <span class="v">${(r.reliability*100).toFixed(0)}%</span></div>
      </div>`;

    bandTableBody.innerHTML='';
    Object.entries(r.bandRates).forEach(([lvl,dat])=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${lvl}</td><td>${dat.ok}</td><td>${dat.total}</td><td>${Math.round(dat.rate*100)}%</td>`;
      bandTableBody.appendChild(tr);
    });

    const recoLines=[];
    const need = (lvl)=>r.bandRates[lvl] && r.bandRates[lvl].rate < ({A1:.70,A2:.65,B1:.60,B2:.60,C1:.55,C2:.50}[lvl]);
    if(r.weightedLevel==="A0"||r.weightedLevel==="A1"){recoLines.push("База: алфавит/фонетика, простые фразы, 1000–1500 слов, ежедневное аудирование уровня A1.");}
    if(r.weightedLevel==="A2"){recoLines.push("Глагольные формы, частотный словарь ~2500, базовые тексты и диалоги A2.");}
    if(r.weightedLevel==="B1"){recoLines.push("Связки речи, придаточные, активная устная практика, короткие эссе.");}
    if(r.weightedLevel==="B2"){recoLines.push("Академическая лексика, сложные конструкции, резюмирование статей.");}
    if(r.weightedLevel==="C1"){recoLines.push("Стиль/регистр, точность формулировок, эссе 250–300 слов, устные презентации.");}
    if(r.weightedLevel==="C2"){recoLines.push("Поддержание уровня: дебаты, редактирование текстов, узкопрофильные материалы.");}
    Object.keys(r.bandRates).forEach(b=>{ if(need(b)) recoLines.push(`Уровень ${b}: дотянуть до целевого порога.`); });
    if(r.reliability<0.7){recoLines.push(t('badReliabilityHint') || "Обнаружены признаки низкой надёжности. Рекомендуется пересдать в спокойных условиях.");}
    qs('#reco').innerHTML = `<ul>${recoLines.map(x=>`<li>${sanitize(x)}</li>`).join('')}</ul>`;

    reviewBtn.onclick = ()=>reviewAnswers();
    printBtn.onclick = ()=>window.print();
    downloadBtn.onclick = ()=>{
      const blob = new Blob([JSON.stringify({generatedAt:new Date().toISOString(),report:r,ui:UI_LANG,test:TEST_LANG},null,2)],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=`cefr_report_${TEST_LANG}.json`; a.click();
      setTimeout(()=>URL.revokeObjectURL(url),1000);
    };
    restartBtn.onclick = ()=>window.location.reload();
  }

  function reviewAnswers(){
    result.scrollIntoView({behavior:'smooth'});
    const container = document.createElement('div'); container.className='grid';
    QUESTIONS.forEach(q=>{
      const chosen = state.answers[q.id];
      const wrap = document.createElement('div'); wrap.className='q';
      wrap.innerHTML = `<div class="level-tag">${q.level}</div><h3 style="margin-top:8px">${sanitize(q.q)}</h3>`;
      q.options.forEach((opt,i)=>{
        const lab=document.createElement('div'); lab.className='opt';
        if(i===q.answerIdx) lab.classList.add('correct');
        if(chosen!==undefined && i===chosen && chosen!==q.answerIdx) lab.classList.add('wrong');
        lab.textContent = opt;
        wrap.appendChild(lab);
      });
      container.appendChild(wrap);
    });
    if(!document.getElementById('reviewBlock')){
      const sec=document.createElement('div'); sec.id='reviewBlock'; sec.className='result'; sec.style.marginTop='12px';
      const h=document.createElement('h3'); h.textContent=t('review') || 'Просмотреть ответы';
      sec.appendChild(h); sec.appendChild(container); result.appendChild(sec);
    }
  }

  /* ========= 9) AI-аудит ========= */
  async function aiAudit(rawReport){
    if(!AI_ENDPOINT || !AI_ENDPOINT.includes('/exec')) {
      qs('#aiStatus').textContent = t('aiNotConnected');
      return;
    }
    const meta = {
      version: "1.0",
      honesty: state.honesty,
      startedAt: new Date(state.startedAt).toISOString(),
      finishedAt: new Date().toISOString(),
      locale: TEST_LOCALE[TEST_LANG] || "en-US",
      testSpec: { totalQuestions: QUESTIONS.length, penaltyWrong: -0.33, hasIDK: true },
      langs: { ui: UI_LANG, test: TEST_LANG }
    };

    let res;
    try {
      res = await fetch(AI_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type":"text/plain" }, // без preflight
        body: JSON.stringify({ intent: "final-assess", data: { rawReport, meta } })
      });
    } catch(e){
      qs('#aiStatus').textContent = t('aiFetchError');
      return;
    }

    let payload;
    try { payload = await res.json(); }
    catch(e){ qs('#aiStatus').textContent = t('aiJsonParseError'); return; }

    const out = payload?.output ?? payload;

    const pretty = (x) => {
      if (x == null) return "unknown";
      if (typeof x === "string") return x;
      try { return JSON.stringify(x).slice(0, 300); } catch (_) { return String(x); }
    };

    if(!res.ok){
      qs('#aiStatus').textContent = (t('aiHttpError')||'AI-аудит HTTP {{STATUS}}: {{MESSAGE}}')
        .replace('{{STATUS}}', String(res.status))
        .replace('{{MESSAGE}}', pretty(out?.error || out));
      return;
    }
    if(!out || out.error){
      qs('#aiStatus').textContent = (t('aiResponseError')||'AI-аудит: {{MESSAGE}}')
        .replace('{{MESSAGE}}', pretty(out?.error || "ошибка ответа"));
      return;
    }

    qs('#aiStatus').classList.add('hidden');
    const aiBox = qs('#aiBox'); aiBox.classList.remove('hidden');
    const adj = out.adjustments || {};
    aiBox.innerHTML = `
      <div class="grid">
        <div class="kpi"><span>${t('aiLevel')||'AI-уровень'}:</span> <span class="v">${sanitize(out.adjustedLevel || "—")}</span></div>
        <div class="kpi"><span>${t('aiConfidence')||'Доверие AI'}:</span> <span class="v">${Math.round((out.confidence||0)*100)}%</span></div>
        <div class="kpi"><span>${t('aiFlags')||'Флаги'}:</span> <span class="v">${(out.flags||[]).map(sanitize).join(', ') || '—'}</span></div>
      </div>
      <div class="hr"></div>
      <div class="small muted">
        ${(t('aiCorrections')||'Коррекции по диапазонам (AI)')}: ${["A1","A2","B1","B2","C1","C2"].map(k=>`${k}: ${adj[k] ?? 0}`).join(' · ')}
      </div>
      <div style="margin-top:8px">${sanitize(out.rationale || (t('aiNoComment')||'Без комментариев.'))}</div>
    `;
  }

  /* ========= 10) Boot ========= */
  (async function boot(){
    await initI18n();
    await initQuestions();

    // порядок вопросов (можно перемешать, если захочешь)
    order = QUESTIONS.map((_,i)=>i);
    total = order.length;

    // прогресс-лейбл на старте
    qs('#progressBadge').textContent = `${t('progressQ') || 'Вопрос'} 1 / ${total}`;

    // Готово к старту
  })();
</script>
</body>
</html>
