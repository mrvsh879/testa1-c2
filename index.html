<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CEFR Тест уровня языка A1–C2 (DE)</title>
<meta name="description" content="Профессиональный тест уровня языка A1–C2 по CEFR. 48 вопросов, антиугадывание, прозрачный отчёт." />
<style>
  :root{
    --bg:#0f1221;--card:#171a2e;--muted:#8b91b2;--text:#e9ecf7;--accent:#6ea8fe;--ok:#2ecc71;--bad:#ff6b6b;--warn:#ffd166;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#0d1020 0%,#0f1221 60%,#0b0f1a 100%);color:var(--text)}
  .wrap{max-width:960px;margin:0 auto;padding:24px}
  .card{background:var(--card);border:1px solid #202547;box-shadow:0 10px 30px rgba(0,0,0,.35);border-radius:16px;padding:20px}
  h1{margin:0 0 12px;font-size:24px;letter-spacing:.2px}
  .muted{color:var(--muted)}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .col{flex:1 1 300px}
  .btn{appearance:none;border:1px solid #27305b;background:#1c2242;color:var(--text);padding:12px 16px;border-radius:12px;font-weight:600;cursor:pointer;transition:.15s}
  .btn:hover{transform:translateY(-1px);background:#212a54}
  .btn.primary{background:linear-gradient(180deg,#6ea8fe,#4c7ef5);border-color:#345bd6;color:#051028}
  .btn.ghost{background:transparent;border-color:#2a335f}
  .btn.warn{background:#3c2e09;border-color:#7d5d00}
  .btn.ok{background:#0f3a26;border-color:#1f7a50}
  .grid{display:grid;gap:14px}
  .kpi{display:flex;align-items:center;gap:8px;padding:10px 12px;background:#11142a;border:1px solid #23264a;border-radius:12px}
  .kpi .v{font-weight:700}
  .bar{height:10px;background:#10142b;border:1px solid #2a2e56;border-radius:999px;overflow:hidden}
  .bar>div{height:100%;background:linear-gradient(90deg,#4c7ef5,#6ea8fe)}
  .q{padding:16px;border:1px solid #242953;border-radius:12px;background:#121634}
  .q h3{margin:0 0 10px;font-size:16px}
  .opt{display:block;border:1px solid #2a2f61;border-radius:10px;padding:10px;cursor:pointer;background:#111539}
  .opt input{margin-right:8px}
  .opt+.opt{margin-top:8px}
  .opt.correct{border-color:#1f8c5a;background:#0e2e22}
  .opt.wrong{border-color:#9e2e2e;background:#2a1111}
  .level-tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #2a2e56;color:#aeb7e8}
  .footer{display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;margin-top:16px}
  .note{padding:10px 12px;background:#0e122b;border:1px dashed #2b3166;border-radius:12px}
  .hidden{display:none}
  .badge{padding:2px 8px;border-radius:999px;border:1px solid #2b3166;background:#0e122b;color:#aeb7e8}
  .result{padding:16px;border:1px solid #2a2e56;border-radius:12px;background:#0f1431}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border-bottom:1px solid #23264c;padding:8px;text-align:left}
  .hr{height:1px;background:#252a53;margin:16px 0}
  .small{font-size:12px}
  .chip{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #2b3166;margin-right:6px;margin-bottom:6px}
  @media (max-width:520px){.footer{flex-direction:column}}
</style>
</head>
<body>
<div class="wrap">
  <div class="card" id="screen-intro">
    <h1>Тест уровня языка A1–C2 (немецкий, CEFR)</h1>
    <p class="muted">48 вопросов (по 8 на каждый уровень A1…C2). Время: 12–20 минут. Антиугадывание включено.</p>
    <div class="row">
      <div class="col grid">
        <div class="kpi"><span>Формат:</span> <span class="v">Multiple choice + “Не знаю”</span></div>
        <div class="kpi"><span>Штраф за ошибку:</span> <span class="v">−0.33</span></div>
        <div class="kpi"><span>Оценка:</span> <span class="v">CEFR A1–C2 + профиль по уровням</span></div>
      </div>
      <div class="col note">
        <strong>Честность важна:</strong> не используйте переводчики, подсказки и материалы.  
        Слишком быстрые ответы по всему тесту помечаются как ненадёжные.
      </div>
    </div>
    <div class="hr"></div>
    <label class="opt" style="background:#0f1431">
      <input type="checkbox" id="honesty" /> Я подтверждаю, что прохожу тест самостоятельно и без переводчиков.
    </label>
    <div class="footer">
      <div class="bar" style="flex:1"><div style="width:0%"></div></div>
      <button class="btn primary" id="startBtn">Начать тест</button>
    </div>
  </div>

  <div class="card hidden" id="screen-test">
    <div class="footer">
      <div><span class="badge" id="progressBadge">Вопрос 1 / 48</span></div>
      <div class="bar" style="flex:1;max-width:400px"><div id="progressBar" style="width:0%"></div></div>
      <div>
        <span class="badge" id="timerBadge">00:00</span>
        <span class="badge" id="speedBadge">скорость: —</span>
      </div>
    </div>

    <div id="questionHost" class="grid" style="margin-top:12px"></div>

    <div class="footer">
      <div class="muted small">Уровень: <span id="lvlTag" class="level-tag">—</span></div>
      <div>
        <button class="btn ghost" id="prevBtn">← Назад</button>
        <button class="btn" id="nextBtn">Далее →</button>
        <button class="btn ok hidden" id="finishBtn">Завершить тест</button>
      </div>
    </div>
  </div>

  <div class="card hidden" id="screen-result">
    <h2 style="margin:0 0 6px">Ваш результат</h2>
    <div id="headline"></div>
    <div class="hr"></div>
    <div class="grid">
      <div class="result" id="summaryBox"></div>
      <div class="result">
        <h3 style="margin:0 0 8px">Профиль по уровням</h3>
        <table class="table" id="bandTable">
          <thead><tr><th>Уровень</th><th>Верно</th><th>Всего</th><th>Точность</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="result">
        <h3 style="margin:0 0 8px">Рекомендации</h3>
        <div id="reco"></div>
      </div>
    </div>
    <div class="hr"></div>
    <div class="footer">
      <button class="btn" id="reviewBtn">Просмотреть ответы</button>
      <button class="btn" id="printBtn">Печать / PDF</button>
      <button class="btn primary" id="downloadBtn">Скачать отчёт (.json)</button>
      <button class="btn ghost" id="restartBtn">Пройти заново</button>
    </div>
  </div>
</div>

<script>
  // ------------------------------
  // ДАННЫЕ ВОПРОСОВ: 48 (8×A1..C2)
  // Формат: { id, level, q, options:[A,B,C,D,"Не знаю"], answerIdx }
  // ------------------------------
  const QUESTIONS = [
    // A1 (8)
    {id:"A1-1",level:"A1",q:"Выберите правильный артикль: ___ Tisch.",options:["Der","Die","Das","Den","Не знаю"],answerIdx:0},
    {id:"A1-2",level:"A1",q:"Как перевести: Ich heiße Anna.",options:["Мне нравится Анна","Меня зовут Анна","Я из Анны","Я люблю Анну","Не знаю"],answerIdx:1},
    {id:"A1-3",level:"A1",q:"Глагол sein, 1 л. ед.: Ich ___ müde.",options:["bist","ist","bin","seid","Не знаю"],answerIdx:2},
    {id:"A1-4",level:"A1",q:"Сколько это? fünf + drei =",options:["7","8","9","6","Не знаю"],answerIdx:1},
    {id:"A1-5",level:"A1",q:"Какой сегодня день? 'Montag' — это…",options:["Понедельник","Вторник","Среда","Четверг","Не знаю"],answerIdx:0},
    {id:"A1-6",level:"A1",q:"Выберите множественное число: das Buch → die ___",options:["Buchs","Büche","Bücher","Buches","Не знаю"],answerIdx:2},
    {id:"A1-7",level:"A1",q:"Местоимение 'мой' (m): ___ Vater",options:["mein","meine","meiner","meins","Не знаю"],answerIdx:0},
    {id:"A1-8",level:"A1",q:"Основной порядок слов: Ich ___ in Berlin.",options:["wohne","wohnt","wohnen","wohnst","Не знаю"],answerIdx:0},

    // A2 (8)
    {id:"A2-1",level:"A2",q:"Отделяемая приставка: Ich ___ um 7 Uhr ___ (aufstehen).",options:["aufstehe … mich","stehe … auf","auf … stehe","stehe … an","Не знаю"],answerIdx:1},
    {id:"A2-2",level:"A2",q:"Akkusativ/Dativ: Ich gebe ___ Bruder das Buch.",options:["der","den","dem","des","Не знаю"],answerIdx:2},
    {id:"A2-3",level:"A2",q:"Модальные: Ich ___ heute arbeiten.",options:["müssen","muss","müsst","müssen wir","Не знаю"],answerIdx:1},
    {id:"A2-4",level:"A2",q:"Прош. время Perfekt: Ich habe gestern viel ___ (lernen).",options:["gelernt","gelernt","gelernen","lernen","Не знаю"],answerIdx:0},
    {id:"A2-5",level:"A2",q:"Сравнение: teuer → ___",options:["teuerer","teurer","am teuersten","teuerste","Не знаю"],answerIdx:1},
    {id:"A2-6",level:"A2",q:"Порядок слов с временным обстоятельством: Heute ___ ich in die Stadt.",options:["gehe","ich gehe","gehe ich","ich gehe heute","Не знаю"],answerIdx:2},
    {id:"A2-7",level:"A2",q:"Предлоги направления: Ich gehe ___ Schule.",options:["zur","bei der","von der","auf der","Не знаю"],answerIdx:0},
    {id:"A2-8",level:"A2",q:"Правильный артикль в Akkusativ (f): Ich sehe ___ Frau.",options:["die","der","eine","eine Frau","Не знаю"],answerIdx:2},

    // B1 (8)
    {id:"B1-1",level:"B1",q:"Придаточное с weil: Ich bleibe zu Hause, weil ich ___.",options:["bin müde","müde bin","bin der müde","müde ist","Не знаю"],answerIdx:1},
    {id:"B1-2",level:"B1",q:"Präteritum модальных: Früher ___ ich nicht gut schwimmen.",options:["kann","konnte","könnte","kannte","Не знаю"],answerIdx:1},
    {id:"B1-3",level:"B1",q:"Относительное предложение: Der Mann, ___ dort steht, ist mein Lehrer.",options:["der","den","dem","dessen","Не знаю"],answerIdx:0},
    {id:"B1-4",level:"B1",q:"Пассив Präsens: Der Brief ___ von ihm geschrieben.",options:["wird","ist geschrieben","wird geschrieben","war geschrieben","Не знаю"],answerIdx:2},
    {id:"B1-5",level:"B1",q:"Genitiv: Das ist das Auto ___ Freundin.",options:["meine","meiner","meines","meinem","Не знаю"],answerIdx:1},
    {id:"B1-6",level:"B1",q:"Прилагательные (best. Art.): der ___ Film",options:["interessanter","interessante","interessantes","interessantem","Не знаю"],answerIdx:1},
    {id:"B1-7",level:"B1",q:"Konjunktiv II (вежливо): ___ Sie mir bitte helfen?",options:["Könnten","Kannst","Würdest","Darfst","Не знаю"],answerIdx:0},
    {id:"B1-8",level:"B1",q:"Союз dass: Er sagt, ___ er morgen kommt.",options:["dass","das","wie","ob","Не знаю"],answerIdx:0},

    // B2 (8)
    {id:"B2-1",level:"B2",q:"Иерархия полей: Heute ___ ich, wäre ich frei, ins Kino gegangen.",options:["gehe","ginge","wäre","würde","Не знаю"],answerIdx:1},
    {id:"B2-2",level:"B2",q:"Пассив с Zustandspassiv: Die Tür ist ___ .",options:["geöffnet","wird geöffnet","öffnete","am Öffnen","Не знаю"],answerIdx:0},
    {id:"B2-3",level:"B2",q:"Устойчивое сочетание: eine Entscheidung ___",options:["nehmen","treffen","machen","setzen","Не знаю"],answerIdx:1},
    {id:"B2-4",level:"B2",q:"Глагол с предлогом: warten ___ den Bus",options:["an","auf","für","über","Не знаю"],answerIdx:1},
    {id:"B2-5",level:"B2",q:"Partizip I/II как прилагат.: die ___ Kinder (schreien)",options:["schreienden","geschrien","schreiende","geschreiende","Не знаю"],answerIdx:2},
    {id:"B2-6",level:"B2",q:"Инверсия при нач. обстоятельстве: Morgen ___ ich keine Zeit.",options:["habe","ich habe","habe ich","ich habe Morgen","Не знаю"],answerIdx:2},
    {id:"B2-7",level:"B2",q:"Косвенная речь: Er sagt, er ___ spät.",options:["kommt","käme","kommen","gekommen","Не знаю"],answerIdx:0},
    {id:"B2-8",level:"B2",q:"Синонимия: „jedoch” ближе по смыслу к…",options:["denn","aber","also","trotzdem","Не знаю"],answerIdx:1},

    // C1 (8)
    {id:"C1-1",level:"C1",q:"Лексика: „nachhaltig” ближе к…",options:["kurzfristig","dauerhaft","zufällig","oberflächlich","Не знаю"],answerIdx:1},
    {id:"C1-2",level:"C1",q:"Коннекторы: ___ er krank war, arbeitete er weiter.",options:["Obwohl","Während","Damit","Sobald","Не знаю"],answerIdx:0},
    {id:"C1-3",level:"C1",q:"Номина-лизация: „die Zusammenarbeit verbessern” → „die ___ der Zusammenarbeit”.",options:["Verbesserung","Verbesserlichkeit","Verbesserungheit","Verbesserungung","Не знаю"],answerIdx:0},
    {id:"C1-4",level:"C1",q:"Идиома: „Das ist nicht mein Bier” значит…",options:["Это не моё дело","Это очень важно","Это мой выбор","Это дорого","Не знаю"],answerIdx:0},
    {id:"C1-5",level:"C1",q:"Стилевое: Научный синоним к „wichtig”",options:["wesentlich","nett","locker","billig","Не знаю"],answerIdx:0},
    {id:"C1-6",level:"C1",q:"Причинно-след.: „Folglich” выражает…",options:["противопоставление","следствие","уступку","условие","Не знаю"],answerIdx:1},
    {id:"C1-7",level:"C1",q:"Глаг.+предлог (абстр.): sich auseinandersetzen ___ einem Thema",options:["über","mit","für","an","Не знаю"],answerIdx:1},
    {id:"C1-8",level:"C1",q:"Союзная группа: „sowohl … als auch …” значит…",options:["или … или","как … так и","не только … но и","хотя … но","Не знаю"],answerIdx:1},

    // C2 (8)
    {id:"C2-1",level:"C2",q:"Стилистика: наиболее формальное?",options:["begreifen","kapieren","verstehen","ersinnen","Не знаю"],answerIdx:3},
    {id:"C2-2",level:"C2",q:"Тонкая семантика: „unterstellen” ближе к…",options:["vermuten (с оттенком обвинения)","übergeben","unterstützen","abwarten","Не знаю"],answerIdx:0},
    {id:"C2-3",level:"C2",q:"Контекст: „Er agiert mit Bedacht.”",options:["импульсивно","обдуманно","пасивно","громко","Не знаю"],answerIdx:1},
    {id:"C2-4",level:"C2",q:"Лексика политики: „haushaltspolitische Konsolidierung” — это…",options:["рост расходов","сокращение дефицита","рост налоговых льгот","монетизация долга","Не знаю"],answerIdx:1},
    {id:"C2-5",level:"C2",q:"Текстовая когезия: лучшая замена указ. слова: „Diese Entwicklung, ___ zufolge …”",options:["deren","derer","welcher","wohin","Не знаю"],answerIdx:0},
    {id:"C2-6",level:"C2",q:"Смысловая точность: „zunehmend heterogen” значит…",options:["всё более неоднородный","всё более однородный","единообразный","несопоставимый","Не знаю"],answerIdx:0},
    {id:"C2-7",level:"C2",q:"Ковалентность: „etw. in Erwägung ___”",options:["bringen","nehmen","setzen","stellen","Не знаю"],answerIdx:0},
    {id:"C2-8",level:"C2",q:"Лексика академ.: „maßgeblich” ближе к…",options:["zufällig","entscheidend","fraglich","überschaubar","Не знаю"],answerIdx:1},
  ];

  // ------------------------------
  // ЛОГИКА ТЕСТА
  // ------------------------------
  const state = {
    startedAt: null,
    current: 0,
    answers: {},         // id -> chosenIdx
    times: {},           // id -> seconds
    qStartAt: null,
    honesty: false,
  };

  const order = QUESTIONS.map((q,i)=>i); // фиксированный порядок для бэндинга по уровням
  const total = order.length;

  // UI refs
  const intro = el('#screen-intro');
  const test = el('#screen-test');
  const result = el('#screen-result');
  const startBtn = el('#startBtn');
  const honesty = el('#honesty');
  const questionHost = el('#questionHost');
  const progressBar = el('#progressBar');
  const progressBadge = el('#progressBadge');
  const lvlTag = el('#lvlTag');
  const prevBtn = el('#prevBtn');
  const nextBtn = el('#nextBtn');
  const finishBtn = el('#finishBtn');
  const timerBadge = el('#timerBadge');
  const speedBadge = el('#speedBadge');

  const headline = el('#headline');
  const summaryBox = el('#summaryBox');
  const bandTableBody = el('#bandTable tbody');
  const reco = el('#reco');
  const reviewBtn = el('#reviewBtn');
  const printBtn = el('#printBtn');
  const downloadBtn = el('#downloadBtn');
  const restartBtn = el('#restartBtn');

  // helpers
  function el(q){return document.querySelector(q)}
  function fmtSec(s){const m=Math.floor(s/60),r=s%60;return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`}
  function clamp(n,a,b){return Math.max(a,Math.min(b,n))}

  // start
  startBtn.addEventListener('click',()=>{
    if(!honesty.checked){alert('Поставьте галочку о честном прохождении.');return;}
    state.honesty = true;
    state.startedAt = Date.now();
    state.qStartAt = Date.now();
    intro.classList.add('hidden');
    test.classList.remove('hidden');
    renderCurrent();
    tick();
  });

  // timer tick
  let tickTimer=null;
  function tick(){
    clearInterval(tickTimer);
    tickTimer = setInterval(()=>{
      const elapsed = Math.floor((Date.now()-state.startedAt)/1000);
      timerBadge.textContent = fmtSec(elapsed);
      const avg = elapsed / Math.max(1,Object.keys(state.answers).length || 1);
      speedBadge.textContent = `скорость: ${avg.toFixed(1)} c/вопр`;
    },1000);
  }

  // navigation
  prevBtn.addEventListener('click',()=>move(-1));
  nextBtn.addEventListener('click',()=>move(1));
  finishBtn.addEventListener('click',()=>finish());

  function move(delta){
    saveTimeForCurrent();
    state.current = clamp(state.current + delta,0,total-1);
    renderCurrent();
  }

  function saveTimeForCurrent(){
    const q = QUESTIONS[order[state.current]];
    const spent = Math.floor((Date.now()-state.qStartAt)/1000);
    state.times[q.id] = (state.times[q.id] || 0) + spent;
    state.qStartAt = Date.now();
  }

  function renderCurrent(){
    const idx = state.current;
    const q = QUESTIONS[order[idx]];
    progressBadge.textContent = `Вопрос ${idx+1} / ${total}`;
    progressBar.style.width = `${((idx+1)/total*100).toFixed(1)}%`;
    lvlTag.textContent = q.level;

    questionHost.innerHTML = '';
    const box = document.createElement('div');
    box.className='q';
    box.innerHTML = `<h3>${q.q}</h3>`;
    q.options.forEach((opt,optIdx)=>{
      const lab = document.createElement('label');
      lab.className='opt';
      const input = document.createElement('input');
      input.type='radio'; input.name='opt'; input.value=optIdx;
      if(state.answers[q.id]===optIdx) input.checked = true;
      lab.appendChild(input);
      lab.appendChild(document.createTextNode(opt));
      lab.addEventListener('click', (e)=>{
        // помечаем ответ
        state.answers[q.id] = optIdx;
        // авто-Next если не последний
        setTimeout(()=>{
          if(state.current<total-1){move(1)} else {
            nextBtn.classList.add('hidden');
            finishBtn.classList.remove('hidden');
          }
        }, 80);
      });
      box.appendChild(lab);
    });
    questionHost.appendChild(box);

    // кнопки
    prevBtn.disabled = idx===0;
    nextBtn.classList.toggle('hidden', idx===total-1);
    finishBtn.classList.toggle('hidden', idx!==total-1);
  }

  function finish(){
    saveTimeForCurrent();
    test.classList.add('hidden');
    clearInterval(tickTimer);
    const report = scoreReport();
    showResult(report);
  }

  // СКОРАЯ: антиугадывание (+1, 0, −0.33)
  function scoreReport(){
    const perBand = {A1:[],A2:[],B1:[],B2:[],C1:[],C2:[]};
    let penalized = 0, correct=0, wrong=0, skip=0;
    const details = [];

    QUESTIONS.forEach(q=>{
      const ans = state.answers[q.id];
      const chose = (ans===undefined)?null:ans;
      let delta = 0;
      let status = 'skip';
      if(chose===null || chose===undefined || chose===4){ // "Не знаю"
        delta = 0; skip++;
      } else if(chose===q.answerIdx){
        delta = 1; correct++;
        status='correct';
      } else {
        delta = -0.33; wrong++;
        status='wrong';
      }
      penalized += delta;
      perBand[q.level].push({id:q.id,correct: chose===q.answerIdx, delta});
      details.push({id:q.id,level:q.level,chosen:chose,correctIdx:q.answerIdx,delta});
    });

    // точность по уровням (по корректности, без штрафов)
    const bandRates = {};
    Object.keys(perBand).forEach(b=>{
      const arr = perBand[b];
      const total = arr.length;
      const ok = arr.filter(x=>x.correct).length;
      bandRates[b] = {ok,total,rate: total? ok/total : 0};
    });

    // критерии прохождения: пороги точности
    const passReq = {A1:.70,A2:.65,B1:.60,B2:.60,C1:.55,C2:.50};
    const orderBands = ["A1","A2","B1","B2","C1","C2"];
    let achieved = "A0";
    for(let i=0;i<orderBands.length;i++){
      const upTo = orderBands[i];
      const allPass = orderBands.slice(0,i+1).every(b=>bandRates[b].rate>=passReq[b]);
      if(allPass) achieved = upTo; else break;
    }

    // надёжность
    const totalSec = Math.floor((Date.now()-state.startedAt)/1000);
    const avgSec = totalSec / Math.max(1, Object.keys(state.answers).length);
    const fast = avgSec < 4.0;
    const allAnswered = (correct+wrong+skip)===QUESTIONS.length;
    const honesty = state.honesty;
    let reliability = 1.0;
    if(fast) reliability -= 0.25;
    if(!honesty) reliability -= 0.15;
    if(skip===0 && wrong>correct) reliability -= 0.1;
    reliability = clamp(reliability,0,1);

    // итоговый "индекс" (нормируем штрафной)
    const maxRaw = QUESTIONS.length; // если все +1
    const norm = clamp((penalized + (QUESTIONS.length*0.33)) / (maxRaw+QUESTIONS.length*0.33), 0, 1);

    return {
      achieved, bandRates, penalized: +penalized.toFixed(2),
      correct, wrong, skip, total: QUESTIONS.length,
      totalSec, avgSec:+avgSec.toFixed(1), reliability:+reliability.toFixed(2),
      norm:+norm.toFixed(2), details
    };
  }

  function showResult(r){
    result.classList.remove('hidden');

    const levelBadges = {
      "A1":"Начальный",
      "A2":"Элементарный",
      "B1":"Средний",
      "B2":"Уверенный средний",
      "C1":"Продвинутый",
      "C2":"Владение",
      "A0":"Ниже A1"
    };

    headline.innerHTML = `
      <div class="kpi"><span>Определённый уровень:</span> <span class="v" style="margin-left:6px">${r.achieved}</span>
        <span class="chip">${levelBadges[r.achieved]||""}</span>
      </div>
    `;

    summaryBox.innerHTML = `
      <div class="grid">
        <div class="kpi"><span>Баллы с антиугадыванием:</span> <span class="v">${r.penalized} / ${QUESTIONS.length}</span></div>
        <div class="kpi"><span>Правильно / Ошибки / «Не знаю»:</span> <span class="v">${r.correct} / ${r.wrong} / ${r.skip}</span></div>
        <div class="kpi"><span>Время:</span> <span class="v">${fmtSec(r.totalSec)} (ср. ${r.avgSec}s/вопр)</span></div>
        <div class="kpi"><span>Надёжность прохождения:</span> <span class="v">${(r.reliability*100).toFixed(0)}%</span></div>
      </div>
    `;

    // таблица по уровням
    bandTableBody.innerHTML='';
    Object.entries(r.bandRates).forEach(([lvl,dat])=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${lvl}</td><td>${dat.ok}</td><td>${dat.total}</td><td>${Math.round(dat.rate*100)}%</td>`;
      bandTableBody.appendChild(tr);
    });

    // рекомендации
    const recoLines = [];
    const need = (lvl)=>r.bandRates[lvl] && r.bandRates[lvl].rate < ({A1:.70,A2:.65,B1:.60,B2:.60,C1:.55,C2:.50}[lvl]);
    if(r.achieved==="A0"||r.achieved==="A1"){recoLines.push("Сфокусируйтесь на базовой грамматике (sein/haben, артикли, порядок слов) и 1000–1500 частотных слов. 20–30 минут чтения + аудирование A1 ежедневно.");}
    if(r.achieved==="A2"){recoLines.push("Закрепите глаголы с отделяемыми приставками, Perfekt, порядок слов с обстоятельствами, модальные. Пополните лексикон до ~2500 слов.");}
    if(r.achieved==="B1"){recoLines.push("Тренируйте придаточные (weil/dass), относительные, Präteritum модальных, Genitiv. Ежедневная речь/письмо 10–15 минут.");}
    if(r.achieved==="B2"){recoLines.push("Отработайте коннекторы, косвенную речь, устойчивые сочетания, пассив обеих типов. Больше чтения публицистики и аналитики.");}
    if(r.achieved==="C1"){recoLines.push("Доработайте академическую лексику, номинализацию, точность формулировок. Пишите аналитические эссе 250–300 слов 2–3× в неделю.");}
    if(r.achieved==="C2"){recoLines.push("Поддерживайте уровень: дебаты, узкоспециализированные тексты, редактирование собственных текстов на стиль/регистр.");}
    // конкретные «узкие» места
    Object.keys(r.bandRates).forEach(b=>{
      if(need(b)) recoLines.push(`Уровень ${b}: повысить точность до целевого порога (${Math.round(({A1:.70,A2:.65,B1:.60,B2:.60,C1:.55,C2:.50}[b])*100)}%). Рекомендуем тематические тренажёры и разбор типовых ошибок.`);
    });
    // предупреждения по надёжности
    if(r.reliability<0.7){recoLines.push("Обнаружены признаки низкой надёжности (слишком быстрые ответы / отсутствие «Не знаю»). Рекомендуется пересдать в спокойных условиях.");}

    reco.innerHTML = `<ul>${recoLines.map(x=>`<li>${x}</li>`).join('')}</ul>`;

    // Кнопки
    reviewBtn.onclick = ()=>reviewAnswers();
    printBtn.onclick = ()=>window.print();
    downloadBtn.onclick = ()=>{
      const blob = new Blob([JSON.stringify({generatedAt:new Date().toISOString(),report:r},null,2)],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a=document.createElement('a');a.href=url;a.download='cefr_report.json';a.click();
      setTimeout(()=>URL.revokeObjectURL(url),1000);
    };
    restartBtn.onclick = ()=>window.location.reload();
  }

  function reviewAnswers(){
    // показать все вопросы с подсветкой
    result.scrollIntoView({behavior:'smooth'});
    const container = document.createElement('div');
    container.className='grid';
    QUESTIONS.forEach(q=>{
      const chosen = state.answers[q.id];
      const wrap = document.createElement('div');
      wrap.className='q';
      wrap.innerHTML = `<div class="level-tag">${q.level}</div><h3 style="margin-top:8px">${q.q}</h3>`;
      q.options.forEach((opt,i)=>{
        const lab = document.createElement('div');
        lab.className='opt';
        if(i===q.answerIdx) lab.classList.add('correct');
        if(chosen!==undefined && i===chosen && chosen!==q.answerIdx) lab.classList.add('wrong');
        lab.textContent = (i===4?'[Не знаю] ':'') + opt.replace('Не знаю','Не знаю');
        wrap.appendChild(lab);
      });
      container.appendChild(wrap);
    });
    // вставим секцию после таблицы (один раз)
    if(!document.getElementById('reviewBlock')){
      const sec = document.createElement('div'); sec.id='reviewBlock';
      sec.className='result'; sec.style.marginTop='12px';
      const h=document.createElement('h3');h.textContent='Разбор вопросов';
      sec.appendChild(h); sec.appendChild(container);
      result.appendChild(sec);
    }
  }

</script>
</body>
</html>
